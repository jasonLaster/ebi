name: Test Sync Endpoint

# This workflow tests the sync endpoint on Vercel deployments.
# Note: deployment_status events from GitHub Actions don't include Vercel URLs.
# For Vercel deployments, use repository_dispatch events from Vercel instead.
on:
  repository_dispatch:
    types:
      - "vercel.deployment.success"
  deployment_status:

jobs:
  test-sync:
    if: |
      github.event_name == 'repository_dispatch' ||
      (github.event_name == 'deployment_status' && github.event.deployment_status.state == 'success')
    runs-on: ubuntu-latest
    timeout-minutes: 10 # Full sync can take time
    environment: ci
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.client_payload.git.sha || github.event.deployment.ref || github.ref }}

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.3.5

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Debug deployment_status event
        if: github.event_name == 'deployment_status'
        run: |
          echo "=== Deployment Status Event Diagnostics ==="
          echo ""
          echo "Event Type: ${{ github.event_name }}"
          echo "Status State: ${{ github.event.deployment_status.state }}"
          echo "Environment: ${{ github.event.deployment_status.environment }}"
          echo ""
          echo "URLs:"
          echo "  target_url: ${{ github.event.deployment_status.target_url }}"
          echo "  environment_url: ${{ github.event.deployment_status.environment_url }}"
          echo ""
          echo "Deployment Info:"
          echo "  ID: ${{ github.event.deployment.id }}"
          echo "  Ref: ${{ github.event.deployment.ref }}"
          echo "  SHA: ${{ github.event.deployment.sha }}"
          echo "  Task: ${{ github.event.deployment.task }}"
          echo "  Environment: ${{ github.event.deployment.environment }}"
          echo "  Production: ${{ github.event.deployment.production_environment }}"
          echo "  Transient: ${{ github.event.deployment.transient_environment }}"
          echo ""
          echo "Created By:"
          echo "  App: ${{ github.event.deployment.performed_via_github_app.name || 'N/A' }}"
          echo "  User: ${{ github.event.deployment.creator.login }}"
          echo ""
          echo "Payload:"
          echo "${{ toJSON(github.event.deployment.payload) }}"
          echo ""
          echo "=== Analysis ==="
          TARGET_URL="${{ github.event.deployment_status.target_url }}"
          if [[ "$TARGET_URL" == *"github.com"*"/actions"* ]]; then
            echo "❌ This deployment_status event is from GitHub Actions, not Vercel"
            echo "   The target_url points to a GitHub Actions run, not a Vercel deployment"
          elif [[ "$TARGET_URL" == *"vercel.app"* ]] || [[ "$TARGET_URL" == *"vercel.com"* ]]; then
            echo "✅ This appears to be a Vercel deployment"
          else
            echo "⚠️  Unknown deployment source (target_url: $TARGET_URL)"
          fi
          echo ""
          ENV_URL="${{ github.event.deployment_status.environment_url }}"
          if [ -z "$ENV_URL" ]; then
            echo "⚠️  environment_url is empty"
          else
            echo "✅ environment_url: $ENV_URL"
          fi
          echo ""
          APP_NAME="${{ github.event.deployment.performed_via_github_app.name }}"
          if [ "$APP_NAME" == "GitHub Actions" ]; then
            echo "❌ Deployment was created by GitHub Actions (not Vercel)"
            echo "   This workflow is triggered by GitHub Actions deployment_status events,"
            echo "   but Vercel deployments should send repository_dispatch events instead."
          fi
          echo ""
          echo "=== Full Deployment Object ==="
          echo "${{ toJSON(github.event.deployment) }}"

      - name: Get deployment URL
        id: deployment
        run: |
          if [ "${{ github.event_name }}" == "repository_dispatch" ]; then
            # Vercel sends repository_dispatch with the deployment URL
            DEPLOYMENT_URL="${{ github.event.client_payload.url }}"
            if [ -z "$DEPLOYMENT_URL" ]; then
              echo "Error: No URL in repository_dispatch event from Vercel"
              exit 1
            fi
            echo "url=${DEPLOYMENT_URL}" >> $GITHUB_OUTPUT
            echo "Using deployment URL from Vercel: ${DEPLOYMENT_URL}"
          elif [ "${{ github.event_name }}" == "deployment_status" ]; then
            # deployment_status from GitHub Actions - try to get Vercel URL
            # Use target_url like v0/Playwright does, but only if it's a valid URL
            DEPLOYMENT_URL="${{ github.event.deployment_status.target_url }}"
            
            # If target_url is a GitHub Actions URL, it's not from Vercel
            if [[ "$DEPLOYMENT_URL" == *"github.com"*"/actions"* ]]; then
              echo "Warning: deployment_status event is from GitHub Actions, not Vercel"
              echo "target_url: ${DEPLOYMENT_URL}"
              echo "environment_url: ${{ github.event.deployment_status.environment_url }}"
              echo ""
              echo "To test Vercel deployments, configure Vercel to send repository_dispatch events"
              echo "or use the Vercel API to fetch the deployment URL for this branch/ref"
              exit 1
            fi
            
            if [ -z "$DEPLOYMENT_URL" ]; then
              echo "Error: No deployment URL found"
              exit 1
            fi
            
            echo "url=${DEPLOYMENT_URL}" >> $GITHUB_OUTPUT
            echo "Using deployment URL: ${DEPLOYMENT_URL}"
          else
            echo "Error: No deployment URL available"
            exit 1
          fi

      - name: Test sync endpoint
        id: test_sync
        run: |
          DEPLOYMENT_URL="${{ steps.deployment.outputs.url }}"
          bun scripts/test-sync.ts "$DEPLOYMENT_URL"

      - name: Report results
        if: always()
        run: |
          if [ "${{ steps.test_sync.outcome }}" == "success" ]; then
            echo "✅ Sync endpoint test completed successfully"
          else
            echo "❌ Sync endpoint test failed"
            exit 1
          fi
