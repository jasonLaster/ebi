name: Test Sync Endpoint

on:
  deployment_status:

jobs:
  test-sync:
    if: ${{ github.event_name == 'deployment_status' && github.event.deployment_status.state == 'success' }}
    runs-on: ubuntu-latest
    timeout-minutes: 10 # Full sync can take time
    environment: ci
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.client_payload.git.sha || github.event.deployment.ref || github.ref }}

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.3.5

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Test sync endpoint
        id: test_sync
        run: |
          echo "${{ toJSON(github.event.deployment_status) }}"
          echo "Testing against Vercel Preview URL: ${{ github.event.deployment_status.target_url }}"
          bun scripts/test-sync.ts "${{ github.event.deployment_status.target_url }}"

      - name: Report results
        if: always()
        run: |
          if [ "${{ steps.test_sync.outcome }}" == "success" ]; then
            echo "✅ Sync endpoint test completed successfully"
          else
            echo "❌ Sync endpoint test failed"
            exit 1
          fi
